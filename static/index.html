<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>è®ºæ–‡ç¿»è¯‘ - Poe API</title>

<!-- React -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<!-- Ant Design -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/4.24.16/antd.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/antd/4.24.16/antd.min.js"></script>

<!-- Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<!-- Babel -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
body { margin:0; background:#f5f7fa; }

.header-box {
  background:white;
  padding:20px;
  position:sticky;
  top:0;
  z-index:1000;
  box-shadow:0 4px 15px rgba(0,0,0,0.08);
}

.container {
  max-width:1200px;
  margin:0 auto;
  padding:20px;
}

.layout {
  display:flex;
  gap:30px;
  margin-top:20px;
}

.sidebar {
  width:260px;
  background:white;
  padding:20px;
  border-radius:10px;
  height:80vh;
  overflow-y:auto;
  position:sticky;
  top:120px;
}

.toc-item {
  cursor:pointer;
  margin:6px 0;
  font-size:14px;
  color:#555;
}

.toc-item.active {
  color:#1677ff;
  font-weight:600;
}

.level-1 { font-weight:600; }
.level-2 { padding-left:16px; }
.level-3 { padding-left:32px; }

.content h1,
.content h2,
.content h3 {
  scroll-margin-top: 220px;
}


.content { flex:1; }

.message-block {
  margin-bottom:30px;
  padding:25px;
  background:white;
  border-radius:10px;
  border:1px solid #eee;
}

.math-block {
  margin: 20px 0;
}

.status-bar {
  background:#e6f4ff;
  color:#1677ff;
  padding:10px;
  border-radius:6px;
  margin-top:10px;
}
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const { useState, useEffect } = React;
const { Button, Upload, Input, message } = antd;

const BASE_URL = "http://127.0.0.1:8000";

function App() {

  // âœ… ä» URL è¯»å– conversationId
  function getConversationIdFromUrl() {
    const match = window.location.pathname.match(/\/chat\/(.+)/);
    return match ? match[1] : null;
  }

  function pushConversationToUrl(id) {
    window.history.pushState({}, "", `/chat/${id}`);
  }

  const [apiKey, setApiKey] = useState(localStorage.getItem("poe_api_key") || "");
  const [conversationId, setConversationId] = useState(getConversationIdFromUrl());
  const [blocks, setBlocks] = useState([]);
  const [toc, setToc] = useState([]);
  const [activeHeading, setActiveHeading] = useState(null);
  const [loading, setLoading] = useState(false);

  useEffect(()=>{ localStorage.setItem("poe_api_key", apiKey); },[apiKey]);

  // âœ… é¡µé¢åŠ è½½æ—¶å¦‚æœ URL æœ‰ id è‡ªåŠ¨åŠ è½½å†å²
  useEffect(() => {
    const id = getConversationIdFromUrl();
    if (id) {
      setConversationId(id);
      loadConversation(id);
    }
  }, []);

  async function loadConversation(id) {
    setLoading(true);
    const res = await fetch(`${BASE_URL}/conversation/${id}`);
    if (!res.ok) {
      message.error("ä¼šè¯ä¸å­˜åœ¨");
      setLoading(false);
      return;
    }
    const data = await res.json();
    const botMessages = data.messages.filter(m => m.role === "bot");
    setBlocks(
      botMessages.map((m,i)=>({
        id: Date.now() + i,
        content: m.content
      }))
    );
    setLoading(false);
  }

  // âœ… æ•°å­¦å¤„ç†å‡½æ•°ï¼ˆä¿æŒä½ åŸæ¥çš„ï¼‰
  function processLatex(text) {
    const displayBlocks = [];
    let index = 0;

    text = text.replace(
      /\\\[((?:[\s\S]*?))\\\]/g,
      (_, formula) => {
        displayBlocks.push(
          `\n\n<div class="math-block">$$$$\n${formula.trim()}\n$$$$</div>\n\n`
        );
        return `__DISPLAY_BLOCK_${index++}__`;
      }
    );

    text = text.replace(
      /\(([^()\n]*?[\\_^][^()\n]*?)\)/g,
      (_, formula) => `\\(${formula}\\)`
    );

    displayBlocks.forEach((block, i) => {
      text = text.replace(`__DISPLAY_BLOCK_${i}__`, block);
    });

    return text;
  }

  useEffect(() => {

    renderMathInElement(document.body,{
      delimiters:[
        { left: "$$", right: "$$", display: true },
        { left: "\\(", right: "\\)", display: false }
      ],
      throwOnError:false,
      strict:false
    });

    const headings = document.querySelectorAll(".content h1, .content h2, .content h3");
    const newToc = [];

    headings.forEach((heading, index) => {
      const id = "heading-" + index;
      heading.id = id;
      newToc.push({
        id,
        text: heading.innerText,
        level: Number(heading.tagName.slice(1))
      });
    });

    setToc(newToc);

  }, [blocks]);

  useEffect(() => {
    const handleScroll = () => {
      const headings = document.querySelectorAll(".content h1, .content h2");
      let current = null;
      headings.forEach(heading => {
        if (heading.getBoundingClientRect().top <= 120) {
          current = heading.id;
        }
      });
      setActiveHeading(current);
    };
    window.addEventListener("scroll", handleScroll);
    return () => window.removeEventListener("scroll", handleScroll);
  }, []);

  // âœ… ä¸Šä¼ 
  const uploadProps = {
    name:"file",
    accept:".pdf",
    showUploadList:false,
    customRequest: async ({ file })=>{
      if(!apiKey){ message.error("è¯·è¾“å…¥ API Key"); return; }

      const formData = new FormData();
      formData.append("file", file);
      formData.append("api_key", apiKey);

      setLoading(true);
      setBlocks([]);

      const res = await fetch(`${BASE_URL}/upload`,{
        method:"POST",
        body:formData
      });

      const data = await res.json();
      setLoading(false);

      if(!res.ok){
        message.error(data.detail || "ä¸Šä¼ å¤±è´¥");
        return;
      }

      setConversationId(data.conversation_id);

      // âœ… å†™å…¥ URL
      pushConversationToUrl(data.conversation_id);

      setBlocks([{ id:Date.now(), content:data.reply }]);
    }
  };

  // âœ… ç»§ç»­ç¿»è¯‘ï¼ˆç°åœ¨æ­£ç¡®ä¼  api_keyï¼‰
  const handleContinue = async ()=>{
    if(!conversationId){ message.warning("è¯·å…ˆä¸Šä¼ è®ºæ–‡"); return; }
    if(!apiKey){ message.warning("è¯·è¾“å…¥ API Key"); return; }

    setLoading(true);

    const formData = new FormData();
    formData.append("api_key", apiKey);

    const res = await fetch(
      `${BASE_URL}/continue/${conversationId}`,
      { method:"POST", body:formData }
    );

    const data = await res.json();
    setLoading(false);

    if(!res.ok){
      message.error(data.detail || "è¯·æ±‚å¤±è´¥");
      return;
    }

    setBlocks(prev=>[
      ...prev,
      { id:Date.now(), content:data.reply }
    ]);
  };

  const resetSession = ()=>{
    window.history.pushState({}, "", "/");
    setConversationId(null);
    setBlocks([]);
  };

  return (
    <>
      <div className="header-box">
        <div className="container">
          <h2>ğŸ“„ è®ºæ–‡ç¿»è¯‘ - Poe API</h2>

          <Input.Password
            placeholder="è¯·è¾“å…¥ Poe API Key"
            value={apiKey}
            onChange={e=>setApiKey(e.target.value)}
            disabled={loading}
            style={{ marginBottom:10 }}
          />

          <Upload {...uploadProps} disabled={loading}>
            <Button type="primary" loading={loading}>
              {loading ? "å¤„ç†ä¸­..." : "ä¸Šä¼  PDF"}
            </Button>
          </Upload>

          <Button
            style={{ marginLeft:10 }}
            onClick={handleContinue}
            loading={loading}
            disabled={loading}
          >
            {loading ? "ç¿»è¯‘ä¸­..." : "ç»§ç»­"}
          </Button>

          <Button
            danger
            style={{ marginLeft:10 }}
            disabled={loading}
            onClick={resetSession}
          >
            é‡æ–°å¼€å§‹
          </Button>

          {loading && <div className="status-bar">â³ æ­£åœ¨ç¿»è¯‘...</div>}
        </div>
      </div>

      <div className="container">
        <div className="layout">

          <div className="sidebar">
            <h3>ç›®å½•</h3>
            {toc.map(item => (
              <div
                key={item.id}
                className={`toc-item level-${item.level} ${activeHeading===item.id?"active":""}`}
                onClick={() =>
                  document.getElementById(item.id)
                    ?.scrollIntoView({behavior:"smooth"})
                }
              >
                {item.text}
              </div>
            ))}
          </div>

          <div className="content">
            {blocks.map(block=>(
              <div
                key={block.id}
                className="message-block"
                dangerouslySetInnerHTML={{
                  __html: marked.parse(processLatex(block.content))
                }}
              />
            ))}
          </div>

        </div>
      </div>
    </>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>